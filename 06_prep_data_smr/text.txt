# SMR_final - 06_prep_data_smr.r (smr.txt to .ma)
# January 29, 2025

# a) Breast cancer (ieu-a-1126)
# b) Breast cancer (GCST004988)
# c) Breast cancer (GCST010098)
# d) Cervical cancer (GCST004833)
# e) Endometrial cancer (GCST006464)
# f) Endometriosis (GCST90269970)
# g) Endometriosis (GCST90205183)
# h) Epithelial ovarian cancer (GCST004462)
# i) Epithelial ovarian cancer (GCST90244167)
# j) Ovarian cancer (ieu-a-1120)

# Set working directory
setwd("/data/projects/endometriosis/smr_final/smr_130_5_9")

# Load libraries
library(data.table)
library(tidyverse)
library(minfi)
library(IlluminaHumanMethylationEPICanno.ilm10b4.hg19)

#!/usr/bin/env Rscript

# 1) PREPARE GWAS ==============================================================
#-------------------------------------------------------------------------------
# a) Breast cancer (ieu-a-1126)
gwas_a <- read_tsv("/data/projects/smr_large_gwas/formatted_barbara/breast_cancer/ieu-a-1126/ieu-a-1126_breast_cancer.smr.txt",
                   col_types = "cccddddi")

# Replace SNP id with CPAID
sort_and_paste_a <- function(x, y) {paste(sort(c(x, y)), collapse = "_")}
alleles_a <- map2(gwas_a$A1, gwas_a$A2, sort_and_paste_a)

gwas_a <- gwas_a %>% 
  mutate(SNP = paste0(SNP, ":", alleles_a))

# Write .ma file
write_tsv(gwas_a, "/data/projects/endometriosis/smr_final/20250120_smr_145_5_20/data/gwas/ieu-a-1126_breast_cancer.ma")

#-------------------------------------------------------------------------------
# b) Breast cancer (GCST004988)
gwas_b <- read_tsv("/data/projects/smr_large_gwas/formatted/GCST004988_breast_carcinoma.smr.txt",
                   col_types = "cccddddi")

# Replace SNP id with CPAID
sort_and_paste_b <- function(x, y) {paste(sort(c(x, y)), collapse = "_")}
alleles_b <- map2(gwas_b$A1, gwas_b$A2, sort_and_paste_b)

gwas_b <- gwas_b %>% 
  mutate(SNP = paste0(SNP, ":", alleles_b))

# Write .ma file
write_tsv(gwas_b, "/data/projects/endometriosis/smr_final/20250120_smr_145_5_20/data/gwas/GCST004988_breast_cancer.ma")

#-------------------------------------------------------------------------------
# c) Breast cancer (GCST010098)
gwas_c <- read_tsv("/data/projects/smr_large_gwas/formatted_barbara/breast_cancer/GCST010098/GCST010098_breast_cancer.smr.txt",
                   col_types = "cccddddi")

# Replace SNP id with CPAID
sort_and_paste_c <- function(x, y) {paste(sort(c(x, y)), collapse = "_")}
alleles_c <- map2(gwas_c$A1, gwas_c$A2, sort_and_paste_c)

gwas_c <- gwas_c %>% 
  mutate(SNP = paste0(SNP, ":", alleles_c))

# Write .ma file
write_tsv(gwas_c, "/data/projects/endometriosis/smr_final/20250120_smr_145_5_20/data/gwas/GCST010098_breast_cancer.ma")

#-------------------------------------------------------------------------------
# d) Cervical cancer (GCST004833)
gwas_d <- read_tsv("/data/projects/smr_large_gwas/fix_gwas/fixed/GCST004833_cervical_cancer.GRCh37.txt",
                   col_types = "cccddddi")

# Replace SNP id with CPAID
sort_and_paste_d <- function(x, y) {paste(sort(c(x, y)), collapse = "_")}
alleles_d <- map2(gwas_d$A1, gwas_d$A2, sort_and_paste_d)

gwas_d <- gwas_d %>% 
  mutate(SNP = paste0(SNP, ":", alleles_d))

# Write .ma file
write_tsv(gwas_d, "/data/projects/endometriosis/smr_final/20250120_smr_145_5_20/data/gwas/GCST004833_cervical_cancer.ma")

#-------------------------------------------------------------------------------
# e) Endometrial cancer (GCST006464)
gwas_e <- read_tsv("/data/projects/smr_large_gwas/formatted_barbara/endometrial_cancer/GCST006464/new/GCST006464_endometrial_cancer.smr.txt",
                   col_types = "cccddddi")

# Replace SNP id with CPAID
sort_and_paste_e <- function(x, y) {paste(sort(c(x, y)), collapse = "_")}
alleles_e <- map2(gwas_e$A1, gwas_e$A2, sort_and_paste_e)

gwas_e <- gwas_e %>% 
  mutate(SNP = paste0(SNP, ":", alleles_e))

# Write .ma file
write_tsv(gwas_e, "/data/projects/endometriosis/smr_final/20250120_smr_145_5_20/data/gwas/GCST006464_new_endometrial_cancer.ma")

#-------------------------------------------------------------------------------
# f) Endometriosis (GCST90269970)
gwas_f <- read_tsv("/data/projects/smr_large_gwas/formatted_barbara/endometriosis/GCST90269970/GCST90269970_endometriosis.smr.txt",
                   col_types = "cccddddi")

# Replace SNP id with CPAID
sort_and_paste_f <- function(x, y) {paste(sort(c(x, y)), collapse = "_")}
alleles_f <- map2(gwas_f$A1, gwas_f$A2, sort_and_paste_f)

gwas_f <- gwas_f %>% 
  mutate(SNP = paste0(SNP, ":", alleles_f))

# Write .ma file
write_tsv(gwas_f, "/data/projects/endometriosis/smr_final/20250120_smr_145_5_20/data/gwas/GCST90269970_endometriosis.ma")

#-------------------------------------------------------------------------------
# g) Endometriosis (GCST90205183)
gwas_g <- read_tsv("/data/projects/smr_large_gwas/formatted_barbara/endometriosis/GCST90205183/GCST90205183_endometriosis.smr.txt",
                 col_types = "cccddddi")

# Replace SNP id with CPAID
sort_and_paste_g <- function(x, y) {paste(sort(c(x, y)), collapse = "_")}
alleles_g <- map2(gwas_g$A1, gwas_g$A2, sort_and_paste_g)

gwas_g <- gwas_g %>% 
  mutate(SNP = paste0(SNP, ":", alleles_g))

# Write .ma file
write_tsv(gwas_g, "/data/projects/endometriosis/smr_final/20250120_smr_145_5_20/data/gwas/GCST90205183_endometriosis.ma")

#-------------------------------------------------------------------------------
# h) Epithelial ovarian cancer (GCST004462)
gwas_h <- read_tsv("/data/projects/smr_large_gwas/fix_gwas/fixed/GCST004462_epithelial_ovarian_cancer.GRCh37.txt",
                   col_types = "cccddddi")

# Replace SNP id with CPAID
sort_and_paste_h <- function(x, y) {paste(sort(c(x, y)), collapse = "_")}
alleles_h <- map2(gwas_h$A1, gwas_h$A2, sort_and_paste_h)

gwas_h <- gwas_h %>% 
  mutate(SNP = paste0(SNP, ":", alleles_h))

# Write .ma file
write_tsv(gwas_h, "/data/projects/endometriosis/smr_final/20250120_smr_145_5_20/data/gwas/GCST004462_epithelial_oc.ma")

#-------------------------------------------------------------------------------
# i) Epithelial ovarian cancer (GCST90244167)
gwas_i <- read_tsv("/data/projects/smr_large_gwas/formatted_barbara/epithelial_oc/GCST90244167/GCST90244167_epithelial_oc.smr.txt",
                   col_types = "cccddddi")

# Replace SNP id with CPAID
sort_and_paste_i <- function(x, y) {paste(sort(c(x, y)), collapse = "_")}
alleles_i <- map2(gwas_i$A1, gwas_i$A2, sort_and_paste_i)

gwas_i <- gwas_i %>% 
  mutate(SNP = paste0(SNP, ":", alleles_i))

# Write .ma file
write_tsv(gwas_i, "/data/projects/endometriosis/smr_final/20250120_smr_145_5_20/data/gwas/GCST90244167_epithelial_oc.ma")

#-------------------------------------------------------------------------------
# j) Ovarian cancer (ieu-a-1120)
gwas_j <- read_tsv("/data/projects/smr_large_gwas/formatted_barbara/ovarian_cancer/ieu-a-1120/new/ieu-a-1120_ovarian_cancer.smr.txt",
                   col_types = "cccddddi")

# Replace SNP id with CPAID
sort_and_paste_j <- function(x, y) {paste(sort(c(x, y)), collapse = "_")}
alleles_j <- map2(gwas_j$A1, gwas_j$A2, sort_and_paste_j)

gwas_j <- gwas_j %>% 
  mutate(SNP = paste0(SNP, ":", alleles_j))

# Write .ma file
write_tsv(gwas_j, "/data/projects/endometriosis/smr_final/20250120_smr_145_5_20/data/gwas/ieu-a-1120_new_ovarian_cancer.ma")

#-------------------------------------------------------------------------------
# k) Uterine fibroids (GCST009158)
gwas_k <- read_tsv("/data/projects/smr_large_gwas/formatted/GCST009158_uterine_fibroid.smr.txt",
                   col_types = "cccddddi")

# Replace SNP id with CPAID
sort_and_paste_k <- function(x, y) {paste(sort(c(x, y)), collapse = "_")}
alleles_k <- map2(gwas_k$A1, gwas_k$A2, sort_and_paste_k)

gwas_k <- gwas_k %>% 
  mutate(SNP = paste0(SNP, ":", alleles_k))

# Write .ma file
#write_tsv(gwas_k, "/data/projects/endometriosis/smr_final/20250120_smr_145_5_20/data/gwas/GCST004988_breast_cancer.ma")
write_tsv(gwas_k, "/data/projects/endometriosis/smr_final/20250120_smr_145_5_20/data/gwas/GCST009158_uterine_fibroids.ma")

#-------------------------------------------------------------------------------
# 2) PREPARE mQTL DATA (SMR BESD FORMAT) ======================================

# Read mQTLs
#mqtls <- read_tsv("/data/projects/endometriosis/tensorQTL_final/new_145/final_sergi/results/tensorqtl/20250117_tensorqtl_145_5e-08.tsv")
#mqtls <- read_tsv("/data/projects/endometriosis/tensorQTL_final/final_20250210/results/tensorqtl_nom/tensorqtl_130_5e-08_20250210_rm_dup_mqtls_chrpos.tsv")
mqtls <- read_tsv("/data/projects/endometriosis/tensorQTL_final/final_20250210/results/tensorqtl_nom/tensorqtl_130_5e-08_20250210.tsv")

# Extract SNP chromosome and SNP position and store in independent columns
mqtls <- mqtls %>% 
  mutate(chr_snp = str_split_i(variant_id, ":", 1)) %>% 
  mutate(pos_snp = str_split_i(variant_id, ":", 2))

# Load EPIC annotation to get CHR, POS, GENE and STRAND from CpG probes
anno <- getAnnotation(IlluminaHumanMethylationEPICanno.ilm10b4.hg19) %>% 
  as_tibble() %>% 
  select(Name, chr, pos, UCSC_RefGene_Name, strand)

colnames(anno) <- c("cpg", "chr_probe", "pos_probe", "gene_probe", "strand_probe")

# Set "." to empty rows in gene column
# Remove "chr" prefix
anno <- anno %>% 
  mutate(gene_probe = if_else(gene_probe == "", ".", gene_probe)) %>% 
  mutate(chr_probe = str_remove_all(chr_probe, "chr"))

# Load genotype counts and calculate A1 frequency
frqx <- read_tsv("/data/projects/endometriosis/qc_final/imputed_159_samples_rsq09_maf001_hwe005_chr1-22_sorted_wo_multiallelic.frqx",
                 col_types = "cccciii",
                 col_select = 1:7)

colnames(frqx) <- c("snp_chr", "snp_name", "a1", "a2", "a1_hom", "het", "a2_hom")

frqx <- frqx %>% 
  mutate(a1_freq = (a1_hom + 0.5*het) / (a1_hom + het + a2_hom))

# Merge mQTL data with the CpG annotation and the calculated frequencies
merged <- mqtls %>% 
  left_join(anno, join_by(phenotype_id == cpg)) %>% 
  left_join(frqx, join_by(variant_id == snp_name))

# Create CPAID for the SNP name
sort_and_paste <- function(x, y) {paste(sort(c(x, y)), collapse = "_")}
alleles_mqtls <- map2(merged$a1, merged$a2, sort_and_paste)

merged <- merged %>% 
  mutate(CPAID = paste0(chr_snp, ":", pos_snp, ":", alleles_mqtls))

# Select columns to recreate a SMR query .txt (easiest text format to convert to BESD)
smrquery <- merged %>% 
  select(CPAID, chr_snp, pos_snp, a1, a2, a1_freq, phenotype_id,
         chr_probe, pos_probe, gene_probe, strand_probe, slope,
         slope_se, pval_nominal) %>% 
  arrange(chr_snp, pos_snp)

colnames(smrquery) <- c("SNP", "Chr", "BP", "A1", "A2", "Freq", "Probe",
                        "Probe_Chr", "Probe_bp", "Gene", "Orientation", "b",
                        "se", "p")

# Remove duplicated mQTLs - revisar esta parte

smrquery <- smrquery %>% 
  mutate(qtl = paste0(SNP, "_", Probe)) %>% 
  filter(!duplicated(qtl)) %>% 
  select(-qtl) 

# Write results
#write_tsv(smrquery, "/data/projects/endometriosis/smr_final/20250120_smr_145_5_20/data/endo_pval5e-08_smrquery.tsv")
write_tsv(smrquery, "/data/projects/endometriosis/smr_final/smr_130_5_9/data/endo_pval5e-08_smrquery.tsv")

# Load results
#endo <- fread("/data/projects/endometriosis/smr_final/20250120_smr_145_5_20/data/endo_pval5e-08_smrquery.tsv")
endo <- fread("/data/projects/endometriosis/smr_final/smr_130_5_9/data/endo_pval5e-08_smrquery.tsv")

dim(endo)     #1190676   14


# Save object
#saveRDS(smrquery, "/data/projects/endometriosis/smr_final/20250120_smr_145_5_20/data/endo_pval5e-08_smrquery.rds")
#smrquery <- readRDS("/data/projects/endometriosis/smr_final/20250120_smr_145_5_20/data/endo_pval5e-08_smrquery.rds")

saveRDS(smrquery, "/data/projects/endometriosis/smr_final/smr_130_5_9/data/endo_pval5e-08_smrquery.rds")
smrquery <- readRDS("/data/projects/endometriosis/smr_final/smr_130_5_9/data/endo_pval5e-08_smrquery.rds")
